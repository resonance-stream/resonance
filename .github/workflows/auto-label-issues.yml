name: Auto Label Issues

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  label-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/issue-label-config.yml
          sparse-checkout-cone-mode: false

      - name: Label issues based on keywords
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            // Read the external configuration file
            let labelConfig;
            try {
              const configPath = '.github/issue-label-config.yml';
              const configContent = fs.readFileSync(configPath, 'utf8');
              labelConfig = yaml.load(configContent);
              console.log('Loaded label configuration successfully');
            } catch (error) {
              console.log(`Warning: Could not load config file: ${error.message}`);
              console.log('Falling back to empty configuration');
              labelConfig = {};
            }

            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = `${title} ${body}`;

            const labelsToAdd = new Set();

            // Process each label from the configuration
            for (const [label, config] of Object.entries(labelConfig)) {
              if (config && config.keywords && Array.isArray(config.keywords)) {
                const hasMatch = config.keywords.some(keyword =>
                  content.includes(keyword.toLowerCase())
                );
                if (hasMatch) {
                  labelsToAdd.add(label);
                }
              }
            }

            // Add labels if any were detected
            if (labelsToAdd.size > 0) {
              const labels = Array.from(labelsToAdd);
              console.log(`Adding labels: ${labels.join(', ')}`);

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labels
                });
              } catch (error) {
                // Labels might not exist yet - log but don't fail
                console.log(`Note: Some labels may not exist yet. Error: ${error.message}`);
                console.log('Consider creating the required labels in your repository settings.');
              }
            } else {
              console.log('No matching keywords found for auto-labeling.');
            }
