name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Rust checks
  rust-fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          components: rustfmt
          cache-enabled: 'false'

      - name: Check formatting
        # Exclude desktop package on Linux (requires glib-sys which isn't available in CI)
        run: |
          cargo fmt -p resonance-api -p resonance-worker -p resonance-shared-config \
            -p resonance-ollama-client -p resonance-lastfm-client -p resonance-test-utils -- --check

  rust-clippy:
    name: Rust Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          components: clippy
          cache-key: clippy

      - name: Run Clippy
        # Exclude desktop package on Linux (requires glib-sys which isn't available in CI)
        run: cargo clippy --workspace --exclude resonance-desktop --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: resonance
          POSTGRES_PASSWORD: resonance_test
          POSTGRES_DB: resonance_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          cache-key: test

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres

      - name: Run database migrations
        env:
          DATABASE_URL: postgres://resonance:resonance_test@localhost:5432/resonance_test
        run: cargo sqlx migrate run --source apps/api/migrations

      - name: Run tests
        env:
          DATABASE_URL: postgres://resonance:resonance_test@localhost:5432/resonance_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-for-ci-minimum-32-characters
          MEILISEARCH_KEY: test-key
        # Exclude desktop package on Linux (requires glib-sys which isn't available in CI)
        run: cargo test --workspace --exclude resonance-desktop --all-features

  # TypeScript checks
  typescript-lint:
    name: TypeScript Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/web
    steps:
      - uses: actions/checkout@v4

      # NOTE: pnpm install runs from repo root (default) because:
      # 1. pnpm-workspace.yaml defines the workspace structure at repo root
      # 2. Running from a subdirectory would miss workspace dependencies in packages/
      # 3. The lockfile (pnpm-lock.yaml) is at repo root and contains all workspace deps
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run ESLint
        run: pnpm lint

  typescript-typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # See typescript-lint job for explanation of why pnpm install runs from root
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      # Build shared-types first as other packages depend on it
      - name: Build shared-types
        run: pnpm --filter @resonance/shared-types build

      - name: Run type check
        run: pnpm typecheck

  typescript-test:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/web
    steps:
      - uses: actions/checkout@v4

      # See typescript-lint job for explanation of why pnpm install runs from root
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run tests
        run: pnpm test

  # Build verification
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [rust-fmt, rust-clippy, typescript-lint, typescript-typecheck]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          cache-key: build

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build Rust workspace
        # Exclude desktop package on Linux (requires glib-sys which isn't available in CI)
        run: cargo build --workspace --exclude resonance-desktop --release

      # Build shared-types first as other packages depend on it
      - name: Build shared-types
        run: pnpm --filter @resonance/shared-types build

      - name: Build frontend
        run: pnpm build
