# ============================================================================
# Docker Build and Publish Workflow
# ============================================================================
# Builds and pushes Docker images to GitHub Container Registry (ghcr.io)
# Triggered on release tags (v*) and supports multi-platform builds
# Uses the reusable docker-build.yml workflow to eliminate duplication
# ============================================================================

name: Docker Build

on:
  push:
    tags:
      - 'v*'
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to use (defaults to sha)'
        required: false
        type: string

jobs:
  # ==========================================================================
  # Build and Push API Image
  # ==========================================================================
  build-api:
    name: Build API Image
    uses: ./.github/workflows/docker-build.yml
    with:
      image-name: resonance-api
      dockerfile: docker/Dockerfile
      context: '.'
      tag-latest: ${{ github.ref_type == 'tag' }}
      tag-sha: ${{ github.event_name == 'workflow_dispatch' }}
      custom-tag: ${{ inputs.tag || '' }}
    permissions:
      contents: read
      packages: write

  # ==========================================================================
  # Build and Push Worker Image
  # ==========================================================================
  build-worker:
    name: Build Worker Image
    uses: ./.github/workflows/docker-build.yml
    with:
      image-name: resonance-worker
      dockerfile: docker/Dockerfile.worker
      context: '.'
      tag-latest: ${{ github.ref_type == 'tag' }}
      tag-sha: ${{ github.event_name == 'workflow_dispatch' }}
      custom-tag: ${{ inputs.tag || '' }}
    permissions:
      contents: read
      packages: write

  # ==========================================================================
  # Create Release Summary
  # ==========================================================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build-api, build-worker]
    if: github.ref_type == 'tag'
    permissions:
      contents: read

    steps:
      - name: Generate release summary
        env:
          REGISTRY: ghcr.io
          REPO_OWNER: ${{ github.repository_owner }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "## Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following Docker images have been published to GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Server" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${REGISTRY}/${REPO_OWNER}/resonance-api:${TAG_NAME#v}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Worker" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${REGISTRY}/${REPO_OWNER}/resonance-worker:${TAG_NAME#v}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`${TAG_NAME#v}\` - This release" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\` - Latest stable release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY
